---
layout:	post
title: "Jenkins+Shell+Git 实现自动同步代码仓库"
date:  2022-06-04
category: 原创
tags: ["Jenkins","Shell","Git"]
---


前段时间接手了一个项目和团队，其中有个琐碎的工作是每周要在两个 Git 代码仓库之间人工做代码同步，这种重复琐碎的工作我是比较抗拒的，肯定要想办法自动化的，这里记录下我从开发人员的视角利用 Jenkins+Shell+Git 实现这些重复琐碎事情自动化的过程。

有读者看完可能觉得为什么不用这样那样更好的方案？包括我自己也是，回头看自己写的文章时觉得既然知道更好的方案那就去学习研究更好的方案，给别人展示更好的方案算了，后来想想我这不是教别人，而是记录和分享实际工作中基于现有资源解决问题的一种思路，有些事情从技术上看挺简单，在实际工作中执行的时候需要协调这样那样的资源配合，推进起来就不那么容易。

## 背景

我们公司作为乙方为客户提供定制化开发，人员以项目组为单位划分，运维作为公共资源是所有项目组共用的。我说的项目是部署在客户私有云 Linux 服务器上的系统，项目开始的时候，我们在私有云上搭建了运行和维护系统所需要的环境，包括 Gitlab 代码仓库、Jenkins 自动部署等等，日常开发运维都是在内网中进行，需要登录 VPN，部署流程如下：

![](/assets/images/20220604/开发部署流程图.png)

1. 开发人员本地提交代码，合并分支并推送到远程 Git 仓库。
2. 开发或运维人员通过 Jenkins 触发自动打包和部署流程。
3. Jenkins 会去远程 Git 仓库拉取最新代码进行编译打包。
4. Jenkins 打包完之后通过 SSH 协议传输构建产物到应用服务器上，传输完会在应用服务器上执行 Shell 编写的部署脚本。

随着项目不断迭代，客户的上级集团要求客户将代码托管在他们新搭建的独立内网的 Git 代码仓库中，这将作为对客户的考核点之一。从技术角度来说，这件事挺简单的，除了打通两个内网的网络之外，还需要安排运维人员负责代码仓库的迁移，修改下 Jenkins 配置，开发人员使用新的代码仓库即可，基本不用开发做什么。

然而在实际工作中，这样的事情是很难推进的，部门和部门之间都存在部门墙，更别说集团和子公司之间了，一方面，迁移后的代码仓库管理权并不在我们和客户手中，每次人员变动需要删除或者新增账号、新增项目什么的都需要跟集团申请，沟通成本高；另一方面客户作为业务部门，迁移到集团的代码仓库跟业务一点关系都没有，根本没动力投入资源去做这件事。所以实际开发中代码仓库还是用我们自己的，但客户为了应对上级集团的考核，要求我们必须定期同步代码到集团代码仓库，很多时候一些琐碎的事情或者奇奇怪怪的需求就是这样诞生的。

按照道理来说，同步代码仓库这件事应该是由运维来做的，因为运维本身就是负责我们自有代码仓库的管理工作，但由于我们公司是以项目组形式划分人员的，运维不归属某个项目组，项目经理只能说协调运维支撑，没法要求人家，而且项目经理觉得随便从开发团队里面找个实习生、初级工程师来做就行了。

所以这样重复琐碎的工作就落在开发团队身上了，在我接手之前，都是开发人员人工在两个仓库之间同步代码的，操作步骤如下：

![](/assets/images/20220604/人工同步Git仓库.png)

1. 开发人员从自有代码仓库拉取代码到本地，这里简称A代码。
2. 开发人员从集团代码仓库拉取代码到本地，这里简称B代码。
3. 开发人员在本地用A代码覆盖B代码并提交，这里不能覆盖.git目录。
4. 开发人员推送代码到集团远程代码仓库。

我接手之后一直想把这些事情自动化，尽管可以安排实习生或初级工程师去做这些琐碎的事情，但我宁愿花时间手把手教会他们怎么自动化，也不愿意我的团队成员将时间花在这些没意义的事情上。

## 分析

本来这事我还想试下协调运维来搞的，跟运维说了我的诉求和想法，运维说没办法，要对方代码仓库配什么钩子之类，想想运维不归我们管，没法要求他做什么，这事只能我们开发自己去做了。

所以问题就变成了在没有对方仓库管理员配合，也没有相关资源投入的情况下，如何实现两个代码仓库之间的代码同步。这样的问题描述还是太笼统了，很难直接从搜索引擎找到解决方案，需要对问题进行分析拆分，形成具体的问题再去搜索，接下来演示下如何基于前面说的人工操作步骤提炼问题、具象化问题，逐步解决问题，进而实现程序化、自动化。

稍微了解或使用过 Git 的人都知道，Git 是有相关命令的，用 Shell 脚本来程序化是最合适的，所以接下来方向就是找到对应的 Git 命令实现前面说的人工操作步骤，编写成 Shell 脚本。

步骤 1 和 2 都是开发人员从代码仓库拉取代码到本地；这两个步骤可以提炼出一个具体的问题：Git 拉取代码的命令是什么？步骤 3. 除了 .git 目录外，开发人员在本地用 A 代码覆盖 B 代码并提交；这个步骤可以提炼出两个问题：1、为什么 .git 目录不能覆盖？2、为什么要在本地用 A 代码覆盖 B 代码并提交？步骤 4. 开发人员推送代码；这个步骤可以提炼出一个具体问题：Git 推送的命令是什么？

继续分析步骤 3 提炼的两个问题，1、为什么 .git 目录不能覆盖？这里就需要找资料了解代码仓库中 .git 目录的作用是什么了，因为 .git 目录保存了远程仓库信息，如果覆盖的话推送的时候还是往自有仓库推送，而不是往集团仓库推送。这里还可以追问，既然不能覆盖 .git 目录是为了保留推送的远程仓库信息，那能不能覆盖了之后再单独修改推送的远程仓库信息呢？是可以的，这个问题的答案很容易搜索到，Git 代码仓库是支持单独设置拉取代码的仓库地址和推送代码的仓库地址的。既然可以单独设置代码仓库的推送地址，那其实就没必要做覆盖这个动作了，直接在从自有仓库拉取的本地仓库上修改推送地址为集团仓库地址就行了。

步骤 3 的第二个问题为什么要在本地用 A 代码覆盖 B 代码并提交？因为要同步两个仓库之间的代码变更，覆盖再提交目的是为了将 A 仓库的代码变更同步到 B 仓库中，虽然会丢失提交历史，但是这个是为了应对考核的，可以接受，当时交接的人是这么跟我说的。我是不愿意就此停止思考的，先不说丢失提交历史这个对我来说不可接受，难道同步代码变更这件事就没有更好的办法了吗，平时开发的时候本地仓库和远程仓库之间不也是两个仓库之间同步代码变更吗，不是一样的场景吗，它们是怎么做到呢？

搞明白这些疑问，其实就知道步骤 3 是由于当时的开发人员对 Git 工具不熟悉，自己琢磨出来的同步代码变更的方法，实际上操作步骤可以演变成如下：

![](/assets/images/20220604/演变后的人工同步Git仓库.png)

1. 开发人员从自有代码仓库拉取代码到本地。
2. 开发人员修改本地仓库的远程推送地址。
3. 开发人员推送代码到集团代码仓库。

经过前面的步骤演进，问题也会具体化，也更容易找到答案，如下：

1. Git 拉取代码的命令是什么？
2. Git 修改本地仓库推送地址的命令是什么？
3. Git 推送代码的命令是什么？

找到这几个问题的答案就可以准备进行 Shell 脚本的编写了。我一般编写 Shell 脚本前都会先找到对应的命令在 Linux 命令行下手动执行验证下，验证的过程中发现还需要解决一个问题，那就是 Git 仓库的认证问题，每次拉取代码和推送代码都需要手动输入账号密码是没办法脚本化的，这个问题很容易通过搜索引擎找到解决办法。

解决完上面说的问题，完成同步代码的 Shell 脚本编写就问题不大了。接下来需要考虑的是怎么触发执行同步代码的脚本，既然需求要求是每周指定时间同步代码，我首先想到的就是 Linux 中的定时任务 crontab，让 crontab 后台指定时间去执行同步代码的 Shell 脚本，这种方案有一个不好的地方，就是我想知道定时任务有没有正常跑，还得登录服务器看日志。

一个更好的方案是结合前面说的部署流程，在 Jenkins 执行部署脚本时触发执行同步代码的脚本，虽然生产环境不会经常执行部署流程，但是测试环境会，基本每天都会执行部署流程，而且执行完之后是可以在 Jenkins 的控制台页面中看到相关的同步日志，最终采取的方案流程如下：

![](/assets/images/20220604/Jenkins+Shell+Git实现代码仓库同步.png)

1. 开发人员通过 Jenkins 触发自动打包和部署流程。
2. Jenkins 会去远程 Git 仓库拉取最新代码进行编译打包。
3. Jenkins 打包完之后会在测试服务器上执行 Shell 编写的部署脚本，部署脚本会触发同步代码仓库脚本的执行。
4. 同步代码仓库的脚本会从自有代码仓库拉取最新代码到本地仓库。
5. 同步代码仓库的脚本会将本地仓库的最新代码推送到集团代码仓库。

## 实现

实际工作中前面的分析阶段相当于出方案，所以前面没给出具体的命令和代码，但要解决哪些问题基本是清楚的了，稍加整理就可以形成技术方案，下面记录下我实现过程中用到的相关命令和 Shell 脚本。

**初始化服务器环境**

```bash
#假设自有仓库地址是：
# http://localhost/myself_repository.git
#假设集团仓库地址是：
# http://localhost/group_repository.git
cd /home/baichao/code_sync_demo
#先配置git需要将接下来输入的账号密码保存起来
git config --global credential.helper store
#拉取自有仓库的代码，回车后按提示输入自有仓库的账号密码
git clone http://localhost/myself_repository.git
#账号密码会被保存在~/.git-credentials文件中
#执行如下命令查看下是不是保存了账号密码
cat ~/.git-credentials
#进入本地仓库目录
cd myself_repository
#查看本地仓库中配置的远程仓库地址信息
git remote -v
#此时会输入如下两行内容：
# origin  http://localhost/myself_repository.git (fetch)
# origin  http://localhost/myself_repository.git (push)
#其中 fetch 就是拉取代码的远程仓库地址，push 就是推送代码的远程仓库地址
#执行如下命令修改推送代码的远程仓库地址
git remote set-url --push origin http://localhost/group_repository.git
#再执行如下命令查看修改结果
git remote -v
#此时会输入如下两行内容：
# origin  http://localhost/myself_repository.git (fetch)
# origin  http://localhost/group_repository.git (push)
#这样每次拉取代码时就是从自有仓库上拉取，推送代码时就往集团仓库上推送，从而实现两个仓库的代码同步
#第一次往集团仓库推送代码时，一般是需要强制推送的，使用如下命令强制推送覆盖集团仓库的代码，这个命令谨慎使用
git push force
#接着按提示输入集团仓库的账号密码即可
#执行完之后可以再查看下密码是不是被保存起来了
cat ~/.git-credentials
#至此服务器自动同步两个代码仓库的环境就弄好了，剩下的就是编写 Shell 脚本
```

**同步代码仓库 Shell 脚本**

```bash
#!/bin/bash -l
source /etc/profile
source ~/.bash_profile
#日志id，每次执行的id都不一样，同一次执行过程日志id是一样的
logId=`date +%y%m%d%H%M%S%N`
demo_dir=/home/baichao/code_sync_demo
#本地代码仓库目录
repository_dir=$demo_dir/myself_repository
#脚本执行日志文件
log_file=$demo_dir/sync.log
#日志打印函数封装，实现同时打印日志到控制台和日志文件中
log(){
  if [ -n "$1" ]; then
        echo "$logId `date +%F" "%T" "`${FUNCNAME[1]} \"$1\"" >> $log_file
        echo "$logId `date +%F" "%T" "`${FUNCNAME[1]} \"$1\""
  fi
}
cd $repository_dir
log "当前目录:$(pwd)"
#同步master分支
/usr/bin/git checkout master
#当前分支
current_branch=$(/usr/bin/git branch|grep "*")
log "开始同步代码:$current_branch"
log "执行git pull"
/usr/bin/git pull
log "执行git push"
/usr/bin/git push
log "同步代码结束"
```

最后在Jenkins 执行的部署脚本中加上一行执行同步代码仓库脚本的语句即可，Jenkins 控制台页面会输出如下日志：

![](/assets/images/20220604/Jenkins 控制台同步代码仓库日志.png)

最后总结下这个方案需要掌握的技术点：

- 了解 Jenkins 自动部署流程。
- 熟悉 Git 基本原理和命令。
- 熟悉 Linux 基本命令和 Shell 脚本。


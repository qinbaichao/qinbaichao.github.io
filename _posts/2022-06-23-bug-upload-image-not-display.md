---
layout:	post
title: "bug定位-上传的图片无法显示"
date:  2022-06-23
category: 原创
tags: ["问题定位","bug"]
---

> 记录开发中遇到的问题以及排查过程。

最近遇到一个图片上传后无法正常显示的问题，这个问题一开始是由某个团队成员负责，下面将这个团队成员称为队友，但这个队友自己没怎么排查就向我求助，为了帮队友提升排查问题的能力，这里先记录下我的排查思路和思考。

我觉得问题的排查思路和背后涉及的知识点是很有价值的，所以一直想将自己遇到过的问题以及排查过程记录下来，但以前认为记录相当于总结，总想着把问题涉及的知识点研究透了才去记录。

最近有不一样的想法，记录不是为了讲述知识点，没必要把涉及的知识点研究透了才去记录，而是为了回顾在当时的知识储备和场景下的排查思路，为什么有那样的排查思路，而且实际上很多时候我们都是在一知半解的情况下进行问题排查的，更多的是做假设，想办法验证假设。

## 问题

我们开发人员接到的问题如下：

1. 后台系统某个功能上传图片后无法正常显示，以前这个功能是正常的。
2. 某个报表功能无法正常导出 Excel 文件。

其中第二个问题是修复第一个问题之后引入的，这里也放在一起分析排查。

## 前置知识

一般我们在开始排查问题之前都会先了解系统的架构、技术栈等信息，我把这些叫做前置知识，下面结合一张系统部署架构图来讲解下这次排查问题的前置知识。

![](/assets/images/20220623/系统部署架构图.png)

- 系统采用微服务架构，使用 Spring Cloud Alibaba 技术栈。
- 系统部署在 Linux 虚拟机中，日志需要登录各服务器查看。
- 流量由 Nginx 分发给网关，网关再分发给具体的服务。
- 文件存放在对象存储中，上传文件需要通过业务服务，访问文件可以通过业务服务，也可以通过 Nginx 直接访问对象存储。
- 每个经过网关的请求都会有个请求 id，这个请求 id 会通过请求头传递给请求经过的服务节点并打印到日志中，同时请求 id 会通过响应头返回给客户端。
- 系统可以通过内网和公网访问，通过公网访问时有安全要求，前端调接口时需要加密请求报文，后端返回的响应报文也需要加密，也就是同一个业务接口既要支持明文调用，也要支持密文调用，加解密由网关负责，业务服务无感知。

## 排查过程

在写这篇文章时，问题已解决，排查也已经结束，而且为了避免暴露业务系统的相关信息，这里会在本地搭建系统运行时环境，结合 Swagger 来模拟当时的排查过程，讲解当时的排查思路和关注点。

一般接到问题，我们首先是从用户的角度去使用有问题的功能，看能不能复现问题，如果是在 pc 浏览器中，那么使用的过程中需要一直开着浏览器开发者工具，因为通过浏览器开发者工具的 Network 面板可以知道接口地址、请求、响应等信息。

![](/assets/images/20220623/请求信息.png)
![](/assets/images/20220623/响应报文.png)

如图所示，通过浏览器控制台可以看到请求和响应相关信息，请求信息截图的响应头中有个 response-id 响应头，这个就是前面提到的请求 id，通过这个请求 id 可以把请求的日志给捞出来，但这里排查问题我不会急着拿这个 id 去看日志，因为这个请求是正常响应的，接口已经正常返回图片路径，日志大概率看不出什么异常来。

我首先想到的是会不会是前端显示的问题，但很快排除了这种可能，因为同样的显示方式，以前上传的图片可以正常显示，现在上传的图片无法显示，这样对比同时也排除了图片访问接口出问题的可能性。

接着通过接口地址找到了具体的接口代码，代码逻辑不复杂，就是将接收到的文件保存到对象存储中，出错的可能性也不大，而且接口并没有报错，正常返回了图片路径，从代码提交历史来看也没人改动过这个接口，基本也排除了文件上传接口的问题。

当时队友提了一下会不会是对象存储出了问题，于是我们排查方向又放在了对象存储上。对象存储是一个基础能力，由别的团队负责，我们作为客户端要验证没问题的话，那直接使用对象存储 SDK 往里面存个文件，再拿出来看下文件是不是正常的就行。

除了图片上传接口用到了对象存储能力，还有其它功能的文件上传接口也用到了对象存储能力，因为图片上传接口本来就是待排查对象，为了控制影响因素，我们使用了其它文件上传接口来验证对象存储是否有问题，通过其它文件上传接口往对象存储里面存了一个文本文件，再从里面拿出来，发现拿出来的文本文件是正常的，这说明对象存储是没有问题的。

![](/assets/images/20220623/文件上传时序图.png)

排除了前端、业务服务接口、对象存储这些节点之后，此时将目光放在了整个链路中剩下的两个节点：Nginx 和网关，但是从前面排查的情况来看，我潜意识里面认为这两个节点都不太可能出问题，因为他们都只是流量转发，而且其它接口和上传文本文件都没有问题，就图片上传有问题，实在想不明白它们有什么出错的可能性。

想不明白就本地搭建运行环境一步步 debug，这是排查问题的终极手段，通过本地 debug 能看到运行时内存里面值是怎么样的，根据经验首先排查网关，思路是这样的：先在本地搭建同样的运行环境，这里是指代码和 Nacos 配置中心都和线上一样，然后直接调业务服务的图片上传接口，看是否上传成功，再通过网关调业务服务的图片上传接口，看是否上传成功。

经过一番排查发现直接调业务服务的图片上传接口，图片是能正常显示的，通过网关调业务服务的图片上传接口，图片是无法显示的，这说明问题出在了网关上。我们网关使用的是 Gateway，由于我对 Gateway 还算有点了解，首先想到的是网关的过滤器可能出了问题，那就要找出网关的所有过滤器，看是哪个过滤器有问题，但是要从这么多依赖和代码中找出实际使用的过滤器不是一件容易的事。

这里分享一个技巧，自己写一个临时过滤器，注册到网关中，在临时过滤器中打断点，通过查看内存中的过滤器链可以知道网关实际使用了哪些过滤器，如下：

![](/assets/images/20220623/网关过滤器debug.png)

这种 debug 的思路可以用在很多场景，比如研究 Spring Security，自己写个 Filter 注册到 Web 容器中，打断点可以知道 Spring Security 是怎么基于 Filter 构建自己框架体系的；研究 Spring Boot 拦截器，自己写个拦截器注册到容器里面打断点可以知道默认的拦截器有哪些；研究 Spring Boot 参数解析器，自己写个参数解析器注册到容器里面打断点可以知道默认参数解析器有哪些等等。

回到问题排查，经过不断 debug 发现网关的某个过滤器中会将请求体序列化成字符串，然后打印到日志中，根据特定条件对请求报文进行解密操作，然后再将序列化之后的字符串重新封装成请求体，再将请求转发给具体的服务接口处理。

对二进制文件序列化成字符串之后重新封装，文件格式已经错乱了，服务接口收到的文件是格式错误的文件，对于文本文件来说，文件里面的内容本身就是文本内容，序列化成字符串之后并不会错乱，这就解释了前面说的情况：图片文件上传有问题，文本文件上传没问题，相关截图如下：

![](/assets/images/20220623/二进制文件序列化截图.png)
![](/assets/images/20220623/文本文件序列化截图.png)

从截图中可以明显看到二进制文件序列化会乱码，文本文件序列化之后是可以正常看到文本内容的，问题就出在这里。

那应该怎么解决呢？既然是序列化导致图片上传有问题，那么对于图片上传请求不走序列化逻辑就行了，问题就变成了怎么识别这种图片上传请求，这里涉及到 HTTP 协议的相关知识，POST 请求中有个 Content-Type 的请求头，一般通过这个请求头可以知道请求体是 json 请求体还是普通 form 表单请求体还是文件 form 表单请求体，如下图：

![](/assets/images/20220623/json请求体.png)
![](/assets/images/20220623/普通form表单请求体.png)
![](/assets/images/20220623/文件form表单请求体.png)

这里没必要针对文件上传请求再区分图片文件上传和文本文件上传，对于文件上传请求统一不进行序列化就好了，所以这个问题的解决方案如下：

![](/assets/images/20220623/文件上传请求不进行序列化.png)

然而采用这个方案之后的第二天发现引入了另一个问题：某个报表功能无法正常导出 Excel 文件，原因是前面说的根据 Content-Type 请求头判断请求体类型的规则只是一种约定，实际上客户端是可以不遵守约定的，一旦客户端不遵守约定，那么前面的代码就可能会出问题。

因为前面写的代码大概意思是如果请求头 Content-Type 的值兼容 multipart/form-data 类型，那就把这种类型的请求都当做文件上传请求，而文件上传请求是不会对请求体进行加密的，所以不会去走解密逻辑，但是如果客户端不按这个规则来设置，比如将非文件上传请求设置为 multipart/form-data 类型，然后请求体进行加密，这种情况下正常是需要网关对请求体进行解密再转发的，但前面的代码会让这种请求跳过解密的逻辑，这样就会出问题，如下：

![](/assets/images/20220623/错误格式的请求类型.png)

这个 415 错误响应涉及不少内容，当时首先是队友去排查这个问题的，这个队友很草率的认为这是前端的问题，需要协调前端去解决，但被我阻止了，因为我觉得他并没有找到本质原因，只是拿错误信息去搜索了下，看到别人说是请求中的 Content-Type 类型不对，然后自己在本地搭建系统运行环境，通过 Swagger 文档调接口没问题，而且 Swagger 文档中发起的请求 Content-Type 的值是正常的，就认为是前端的问题。

从表面上来看，好像没毛病，可是深挖一下就发现不对劲，前端最近并没有更新过代码，只有后端更新过，如果是前端的问题，为什么之前没问题？其它接口的 Content-Type 请求头是正常的，难道是前端单独针对这个接口设置了 Content-Type 值？这不太可能，前端为什么要这样做呢？如果不是前端手动设置的，而是浏览器自动识别得出这种类型，就算前端针对这个接口设置了固定类型，那其它接口还是有可能会出现这种错误，要从根本上解决问题还是要找出本质原因。

我的排查思路和队友不一样，出了问题首先结合线上日志看执行流程，而不是在本地搭建模拟环境，实际上第一个问题也应该是先看日志的，如果先看日志就不用做那么多假设，也不用花那么多时间精力去验证假设了，这个系统设计了请求 id，通过这个 id 很容易把请求的日志都捞出来，如下：

![](/assets/images/20220623/请求id.png)
![](/assets/images/20220623/网关日志.png)
![](/assets/images/20220623/业务服务日志.png)

通过追踪日志链路，我们很快知道错误发生在业务服务，而且是在服务接口逻辑之前，也就是还没进入到我们大多数后端开发比较熟悉的 controller 里面，这个错误大概是说不支持这种请求类型的处理，那为什么会不支持这种请求呢？看到这个错误我想到了 Spring Boot 的参数解析器。

如果你是 Java 后端开发，这里可以扩展思考下，平时我们开发一个接口，使用实体类来接收请求参数，有没有想过是谁帮我们从请求里面解析参数然后生成实体类实例给我们用的？

这背后其实就是参数解析器在起作用，框架默认的参数解析器满足大部分业务场景，也支持我们自定义参数解析器，它会根据一定规则来决定选择哪个参数解析器进行参数的解析，其中一个规则就是根据 Content-Type 请求头的类型来选择参数解析器，上面的报错应该就是选择的参数解析器无法解析这个请求中的参数，为什么解析不了呢？

因为标注为 multipart/form-data 类型的请求一般会被认为是文件上传请求，就算请求体里面没有文件，它的请求参数也应该是 key-value 格式的，框架选择的参数解析器会按照这样的规则从请求里面解析参数，而前面说了这个报错请求的请求体实际上一个加密的字符串，这会导致参数解析器解析的时候报错，报错被框架的异常处理机制捕获并封装为前面看到的错误响应。

正常来说加密的请求体应该在网关层面就进行解密的，而不是将密文传给业务服务接口，在解决第一个问题的时候没有考虑到客户端不按约定设置 Content-Type 请求头类型，统一认为 multipart/form-data 类型都不需要解密的，所以导致了网关跳过解密逻辑，将密文转给了业务服务，这才是第二个问题的本质原因。

定位到了原因，解决问题就不是什么难事了，既然 multipart/form-data 类型的请求里面包含了需要进行解密的非文件上传请求，那就在 multipart/form-data 类型的请求下再增加一个判断逻辑判断不需要进行解密的请求才直接放行，否则去执行解密逻辑，如下：

![](/assets/images/20220623/文件上传请求不进行序列化-2.png)

至于怎么判断请求是否需要进行解密，这里就不展开了，这跟业务背景和网关加解密功能有关，估计得单独写篇文章介绍了。

上面参数解析器的逻辑是基于我之前对参数解析器的研究写的理解，这次排查问题的过程没有深入源码 debug 验证，不一定对，仅供参考，大家知道参数解析器的存在就行了。

## 总结

简简单单的一个上传图片无法展示的问题现象，背后涉及了系统的所有链路，非常考验定位问题的人对请求链路的理解和相关技术广度，想想这次定位的问题没有卡点，比较高效，离不开下面几点：

- 对请求的链路，经过的节点有比较深刻的理解，排查问题的过程中脑海始终是有那种请求链路图的。
- 系统从架构层面设计了请求 id 并返回给客户端，通过请求 id 很方便就找出请求打印的日志。
- 对 HTTP 协议有一定了解，熟悉 Content-Type 请求头的作用和影响。
- 熟悉 Spring Boot 参数解析机制，知道参数解析器的存在。
- 了解 Spring Gateway 网关处理流程，知道过滤器的存在。
- 掌握一定的 debug 技巧。
- 具备一定的动手能力，排查问题过程中需要不断想办法验证假设。

一个问题的定位就可以将很多知识点、技巧、业务流程串起来，我觉得定位问题是快速熟悉一个项目的方式。